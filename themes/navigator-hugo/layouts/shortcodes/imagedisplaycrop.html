
 {{ $src := (.Get "src") }}
 
 {{ $srcimg := $.Page.Resources.GetMatch $src }}
 {{ $srcimg_width := $srcimg.Width }}
 {{ $srcimg_height := $srcimg.Height }}
 {{ $srcimg_ratio := div (float $srcimg_height) (float $srcimg_width) }} 
 {{ $width := int (default $srcimg.Width (.Get "width")) }}
 {{ $ratio := float (default $srcimg_ratio (.Get "ratio")) }}
 {{ $layout := .Get "layout" }}
 
 {{ $height := int (mul $width $ratio) }}
 
 {{ $wmax := mul $width 2 }}
 {{ $wmin := int (div $width 4) }}
 
{{ $array := slice 3 2 1.5 1 }}
 
 {{ $dict := dict }}
 {{ range $array }}
     {{ $crop_prm := printf "%dx%d" (int (mul $width .)) (int (mul $height .)) }}
     {{ $cropsize:= print $crop_prm " top"}}
     {{ $crop_img := $srcimg.Resize $cropsize }}
     {{ $dict = merge $dict (dict (string .) $crop_img.RelPermalink) }}
 {{ end }}
 
 <img src='' width='{{ $width }}' height='{{ $height }}'
 srcset='{{ range $array }}{{ printf "\n%s" (index $dict (string .)) }}{{ printf " %sx," (string .)}}{{ end }}'></img>
